---
// filepath: /home/mostafa/Documents/Mostafa/Software/Projects/gemvoyage-astro/src/components/CommentSection.astro
import AuthorInfo from './AuthorInfo.astro';
import { API_BASE_URL } from '../lib/apiConfig';

interface Props {
  gemId: string;
  initialComments?: any[];
}

const { gemId, initialComments = [] } = Astro.props;

// Fetch comments server-side
let comments = initialComments;
try {
  const res = await fetch(`${API_BASE_URL}/gem_comment/gem/${gemId}`);
  if (res.ok) {
    comments = await res.json();
  }
} catch (error) {
  console.error('Failed to fetch comments:', error);
}
---
<div class="mt-8">
  <h3 class="text-xl font-bold mb-6">
    Comments (<span id="comment-count">{comments.length}</span>)
  </h3>
  
  <!-- Login prompt for unauthenticated users -->
  <div id="login-prompt" class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
    <p class="text-blue-800 mb-2">Want to share your thoughts?</p>
    <a href="/login" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white h-10 px-4 py-2">
      Login to Comment
    </a>
  </div>
  
  <form id="comment-form" class="mb-8 hidden">
    <div class="flex gap-4">
      <div class="flex h-10 w-10 shrink-0 overflow-hidden rounded-full">
        <img src="https://i.pravatar.cc/150" alt="Your avatar" class="aspect-square h-full w-full" />
      </div>
      <div class="flex-1">
        <textarea 
          id="comment-textarea"
          placeholder="Share your thoughts about this gem..." 
          class="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 mb-3"
        ></textarea>
        <div class="flex justify-end">
          <button 
            type="submit" 
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gem-300 hover:bg-gem-400 h-10 px-4 py-2"
            id="submit-btn"
          >
            Post Comment
          </button>
        </div>
      </div>
    </div>
  </form>
  
  <div id="comments-container" class="space-y-6">
    {comments.map((comment) => (
      <div id={comment.id} class="rounded-lg border p-4 animate-fade-in">
        <div class="flex justify-between">
          <div class="flex items-center gap-3">
            <div>
              <p class="font-medium text-sm">
                <AuthorInfo authorId={comment.ownerId} />
              </p>
              <p class="text-xs text-muted-foreground">
                {new Intl.RelativeTimeFormat('en', { numeric: 'auto' }).format(
                  Math.floor((new Date(comment.createdAt).getTime() - Date.now()) / (1000 * 60 * 60 * 24)), 
                  'day'
                )}
              </p>
            </div>
          </div>
        </div>
        
        <div class="mt-3">
          <p class="text-sm">{comment.comment}</p>
        </div>
      </div>
    ))}
  </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>

<script define:vars={{ gemId, API_BASE_URL }}>
  const form = document.getElementById('comment-form');
  const textarea = document.getElementById('comment-textarea');
  const submitBtn = document.getElementById('submit-btn');
  const commentsContainer = document.getElementById('comments-container');
  const commentCount = document.getElementById('comment-count');
  const loginPrompt = document.getElementById('login-prompt');

  function getIsLoggedIn() {
    return (
      localStorage.getItem('isLoggedIn') === 'true' &&
      localStorage.getItem('access_token') !== null &&
      localStorage.getItem('userId') !== null
    );
  }

  function updateAuthUI() {
    const isLoggedIn = getIsLoggedIn();
    if (isLoggedIn) {
      form?.classList.remove('hidden');
      loginPrompt?.classList.add('hidden');
    } else {
      form?.classList.add('hidden');
      loginPrompt?.classList.remove('hidden');
    }
    return isLoggedIn;
  }

  let isLoggedIn = updateAuthUI();

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      isLoggedIn = updateAuthUI();
    });
  }

  // Modern toast notification function
  function showToast(title, description, variant = 'default') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    const bgColor = variant === 'destructive' ? 'bg-red-500' : 'bg-green-500';
    const iconColor = variant === 'destructive' ? 'text-red-100' : 'text-green-100';
    const icon = variant === 'destructive' ? '⚠️' : '✅';
    
    toast.className = `${bgColor} text-white p-4 rounded-lg shadow-lg mb-2 max-w-sm transform transition-all duration-300 translate-x-full`;
    toast.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="text-lg">${icon}</span>
        <div class="flex-1">
          <div class="font-semibold text-sm">${title}</div>
          <div class="text-xs opacity-90">${description}</div>
        </div>
        <button class="text-white hover:text-gray-200 ml-2" onclick="this.parentElement.parentElement.remove()">
          ×
        </button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
      toast.classList.remove('translate-x-full');
    }, 10);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }
    }, 5000);
  }

  // Show modern notification for unauthenticated users
  function showLoginNotification() {
    showToast('Authentication Required', 'Please login to post a comment', 'destructive');
  }

  function formatDistanceToNow(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return 'just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
    return `${Math.floor(diffInSeconds / 86400)} days ago`;
  }

  async function loadComments() {
    try {
      const res = await fetch(`${API_BASE_URL}/gem_comment/gem/${gemId}`);
      if (!res.ok) throw new Error('Failed to fetch comments');
      const comments = await res.json();
      
      commentsContainer.innerHTML = comments.map(comment => `
        <div class="rounded-lg border p-4 animate-fade-in">
          <div class="flex justify-between">
            <div class="flex items-center gap-3">
              <div>
                <p class="font-medium text-sm">User ${comment.ownerId}</p>
                <p class="text-xs text-muted-foreground">
                  ${formatDistanceToNow(new Date(comment.createdAt))}
                </p>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <p class="text-sm">${comment.comment}</p>
          </div>
        </div>
      `).join('');
      
      commentCount.textContent = comments.length;
    } catch (error) {
      showToast('Error', 'Failed to fetch comments.', 'destructive');
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Double-check authentication before submitting
    if (!isLoggedIn) {
      showLoginNotification();
      return;
    }
    
    const commentText = textarea.value.trim();
    if (!commentText) return;
    
    const userId = localStorage.getItem('userId');
    if (!userId) {
      showLoginNotification();
      return;
    }

    const newComment = {
      id: crypto.randomUUID(),
      createdAt: new Date().toISOString(),
      gemId,
      ownerId: userId,
      comment: commentText,
    };

    try {
      submitBtn.disabled = true;
      
      const res = await fetch(`${API_BASE_URL}/gem_comment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newComment),
      });
      
      if (!res.ok) {
        showToast('Error', 'Failed to post comment.', 'destructive');
        return;
      }
      
      await loadComments();
      textarea.value = '';
      showToast('Success', 'Comment posted!', 'default');
    } catch (error) {
      showToast('Error', 'Failed to post comment.', 'destructive');
    } finally {
      submitBtn.disabled = false;
    }
  });

  textarea.addEventListener('input', () => {
    submitBtn.disabled = !textarea.value.trim();
  });
</script>