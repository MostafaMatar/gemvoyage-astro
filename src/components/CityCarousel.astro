---
import { API_BASE_URL } from '../lib/apiConfig';

interface City {
  id: string;
  name: string;
  description: string;
  image?: string;
}

// Fetch cities from API
let cities: City[] = [];
let error: string | null = null;

try {
  const response = await fetch(`${API_BASE_URL}/city`);
  
  if (!response.ok) {
    throw new Error(`Failed to fetch cities: ${response.status} ${response.statusText}`);
  }
  
  const data = await response.json();
  cities = data;
} catch (err) {
  console.error('Error fetching cities:', err);
  error = err instanceof Error ? err.message : 'Failed to fetch cities';
  cities = [];
}

const { className = '' } = Astro.props;

function cn(...classes: (string | undefined)[]) {
  return classes.filter(Boolean).join(' ');
}
---

<section class={cn("py-12", className)}>
  <div class="container mx-auto px-4">
    <div class="mb-8">
      <h2 class="text-3xl font-bold">Explore Cities</h2>
      <p class="text-muted-foreground mt-2">
        Discover amazing destinations around the world.
      </p>
    </div>
    
    {error ? (
      <div class="flex items-center justify-center h-96">
        <div class="text-center">
          <p class="text-muted-foreground mb-4">
            Unable to load cities at the moment.
          </p>
          <span class="inline-flex items-center rounded-full border font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80 px-2.5 py-0.5 text-xs">
            {error}
          </span>
        </div>
      </div>
    ) : cities.length === 0 ? (
      <div class="flex items-center justify-center h-96">
        <div class="text-center">
          <svg class="mx-auto h-12 w-12 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <p class="text-muted-foreground">
            No cities available at the moment.
          </p>
        </div>
      </div>
    ) : (
      <div class="relative mb-8 mx-auto">
        <div class="w-full overflow-hidden rounded-xl" id="cityCarousel">
          <div class="flex transition-transform duration-500 ease-in-out" id="carouselContent">
            {cities.map((city, index) => (
              <div class="w-full flex-shrink-0" data-index={index}>
                <a href={`/city/${encodeURIComponent(city.name.toLowerCase().replace(/\s+/g, '-'))}`} class="block group">
                  <!-- Exact Card structure matching React -->
                  <div class="rounded-lg border bg-card text-card-foreground shadow-sm w-full h-[400px] sm:h-[450px] md:h-[500px] overflow-hidden border-0 rounded-xl cursor-pointer transition-transform duration-300 hover:scale-[1.02]">
                    <div class="relative w-full h-full">
                      <!-- Background Image -->
                      {city.image ? (
                        <div
                          class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-50 transition-transform duration-700 group-hover:scale-105"
                          style={`background-image: url(${city.image})`}
                          data-image-url={city.image}
                        ></div>
                      ) : (
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-800 opacity-50">
                          <div class="absolute inset-0 bg-black/20"></div>
                        </div>
                      )}

                      <!-- Overlay -->
                      <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/50 to-black/20"></div>

                      <!-- Content -->
                      <div class="relative h-full flex items-end p-4 sm:p-6 md:p-8 lg:p-12 sm:pl-20 md:pl-24">
                        <div class="w-full space-y-2 sm:space-y-3 md:space-y-4">
                          <div class="space-y-1 sm:space-y-2 pl-12">
                            <!-- Exact Badge structure -->
                            <span class="inline-flex items-center rounded-full border font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-secondary text-secondary-foreground hover:bg-secondary/80 bg-white/20 text-white border-white/20 backdrop-blur-sm text-xs sm:text-sm px-2.5 py-0.5">
                              Featured
                            </span>
                            
                            <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl font-bold text-white leading-tight">
                              {city.name}
                            </h1>
                          </div>
                          
                          <p class="text-sm sm:text-base md:text-lg lg:text-xl text-white/90 leading-relaxed max-w-3xl pl-12">
                            <span class="sm:hidden">
                              {city.description.length > 100 ? `${city.description.substring(0, 100)}...` : city.description}
                            </span>
                            <span class="hidden sm:block">
                              {city.description}
                            </span>
                          </p>
                          
                          <!-- Hover indicator -->
                          <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 pt-1 sm:pt-2 pl-12">
                            <span class="inline-flex items-center rounded-full border font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-input bg-background hover:bg-accent hover:text-accent-foreground bg-white/10 text-white border-white/30 text-xs sm:text-sm px-2.5 py-0.5">
                              Click to explore â†’
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            ))}
          </div>
          
          <!-- Navigation buttons - exact structure -->
          {cities.length > 1 && (
            <>
              <button class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10 absolute left-4 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white/90 border-white/20 backdrop-blur-sm" id="prevBtn">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10 absolute right-4 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white/90 border-white/20 backdrop-blur-sm" id="nextBtn">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </>
          )}
        </div>

        <!-- Dot indicators -->
        {cities.length > 1 && (
          <div class="flex justify-center mt-6 space-x-2">
            {cities.map((_, index) => (
              <button
                class="w-2 h-2 rounded-full transition-all duration-300 bg-muted-foreground/30 hover:bg-muted-foreground/50 dot-indicator"
                data-index={index}
              ></button>
            ))}
          </div>
        )}
      </div>
    )}
  </div>
</section>

<script define:vars={{ cities }}>
  class CityCarousel {
    constructor() {
      this.currentIndex = 0;
      this.totalItems = cities.length;
      this.autoplayInterval = null;
      
      if (this.totalItems > 0) {
        this.init();
      }
    }

    init() {
      const container = document.getElementById('carouselContent');
      const dots = document.querySelectorAll('.dot-indicator');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      if (!container) return;
      
      // Handle image errors
      this.handleImageErrors();
      
      // Set initial active dot
      this.updateDots();
      
      // Event listeners
      if (this.totalItems > 1) {
        prevBtn?.addEventListener('click', () => this.prev());
        nextBtn?.addEventListener('click', () => this.next());
        
        dots.forEach((dot, index) => {
          dot.addEventListener('click', () => this.goTo(index));
        });

        // Auto-play (only if more than one city)
        this.startAutoplay();
        
        // Pause autoplay on hover
        const carousel = document.getElementById('cityCarousel');
        carousel?.addEventListener('mouseenter', () => this.stopAutoplay());
        carousel?.addEventListener('mouseleave', () => this.startAutoplay());
      }
    }

    handleImageErrors() {
      const imageElements = document.querySelectorAll('.city-bg-image[data-image-url]');
      imageElements.forEach((element) => {
        const imageUrl = element.getAttribute('data-image-url');
        if (imageUrl) {
          const img = new Image();
          img.onload = () => {
            // Image loaded successfully
          };
          img.onerror = () => {
            // Image failed to load, show fallback
            element.style.display = 'none';
            const fallback = element.parentElement?.querySelector('.image-fallback');
            if (fallback) {
              fallback.classList.remove('hidden');
            }
          };
          img.src = imageUrl;
        }
      });
    }

    updateCarousel() {
      const container = document.getElementById('carouselContent');
      if (container && this.totalItems > 1) {
        container.style.transform = `translateX(-${this.currentIndex * 100}%)`;
      }
      this.updateDots();
    }

    updateDots() {
      const dots = document.querySelectorAll('.dot-indicator');
      dots.forEach((dot, index) => {
        if (index === this.currentIndex) {
          dot.classList.remove('w-2', 'bg-muted-foreground/30');
          dot.classList.add('w-8', 'bg-primary');
        } else {
          dot.classList.remove('w-8', 'bg-primary');
          dot.classList.add('w-2', 'bg-muted-foreground/30');
        }
      });
    }

    next() {
      if (this.totalItems <= 1) return;
      this.currentIndex = (this.currentIndex + 1) % this.totalItems;
      this.updateCarousel();
    }

    prev() {
      if (this.totalItems <= 1) return;
      this.currentIndex = (this.currentIndex - 1 + this.totalItems) % this.totalItems;
      this.updateCarousel();
    }

    goTo(index) {
      if (this.totalItems <= 1) return;
      this.currentIndex = index;
      this.updateCarousel();
    }

    startAutoplay() {
      if (this.totalItems <= 1) return;
      this.stopAutoplay();
      // Match React component's 5000ms delay
      this.autoplayInterval = setInterval(() => this.next(), 5000);
    }

    stopAutoplay() {
      if (this.autoplayInterval) {
        clearInterval(this.autoplayInterval);
        this.autoplayInterval = null;
      }
    }
  }

  // Initialize carousel when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new CityCarousel();
  });
</script>
