---
import Layout from '../layouts/Layout.astro';
---

<Layout 
  title="Authenticating... | GemVoyage"
  description="Processing authentication callback for GemVoyage account access."
  noIndex={true}
>
  <div class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-lg text-gray-600">Authenticating...</p>
    </div>
  </div>

  <script is:inline>
    const API_BASE_URL = import.meta.env.PUBLIC_API_BASE_URL;

    const handleAuthCallback = async () => {
      try {
        // Simple auth callback without Supabase client
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token');
        const userId = urlParams.get('user_id');

        if (accessToken && userId) {
          localStorage.setItem('access_token', accessToken);
          localStorage.setItem('userId', userId);
          localStorage.setItem('isLoggedIn', 'true');

          const profileRes = await fetch(`${API_BASE_URL}/user_profiles/${encodeURIComponent(userId)}`);
          if (profileRes.ok) {
            window.location.href = '/';
          } else {
            window.location.href = '/complete-profile';
          }
        } else {
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Authentication callback error:', error);
        window.location.href = '/login';
      }
    };

    // Run the authentication callback when the page loads
    document.addEventListener('DOMContentLoaded', handleAuthCallback);
  </script>
</Layout>
