---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Sign In | GemVoyage">
    <Navbar />
  <section>
    <div class="max-w-md mx-auto p-4">
      <h1 class="text-2xl font-bold mb-4 text-center">Sign In</h1>

      <form class="login-form">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2" for="email">Email</label>
          <input
            id="email"
            name="email"
            type="email"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2" for="password">Password</label>
          <input
            id="password"
            name="password"
            type="password"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <button
          type="submit"
          class="py-2 px-4 bg-primary text-white font-bold w-full rounded hover:bg-primary-dark"
        >
          Login
        </button>

        <div class="error-message text-red-600 text-sm mt-2 text-center hidden">
          <span class="error-text"></span>
        </div>
      </form>

      <!-- Divider -->
      <div class="flex items-center my-6">
        <hr class="flex-grow border-gray-300" />
        <span class="mx-2 text-gray-500 text-sm">or</span>
        <hr class="flex-grow border-gray-300" />
      </div>

      <!-- Google Sign-In Button -->
      <button
        id="google-signin"
        class="flex items-center justify-center gap-2 w-full py-2 px-4 border border-gray-300 rounded hover:bg-gray-50 transition-colors"
      >
        <img
          src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
          alt="Google logo"
          class="w-5 h-5"
        />
        <span class="font-medium text-gray-700">Sign in with Google</span>
      </button>

      <p class="mt-4 text-center">
        Don't have an account? <a href="/register" class="text-blue-600 hover:text-blue-500">Register here</a>
      </p>
    </div>
</section>
<Footer />
</Layout>

<script is:inline>
  function initializeLogin() {
    const API_BASE_URL = 'https://api.gemvoyage.net'; // Replace with actual API URL
    const form = document.querySelector('.login-form');
    const errorMessage = document.querySelector('.error-message');
    const submitButton = form.querySelector('button[type="submit"]');

    function showError(message) {
      errorMessage.querySelector('.error-text').textContent = message;
      errorMessage.classList.remove('hidden');
    }

    function hideError() {
      errorMessage.classList.add('hidden');
    }

    // Form submission - matches LoginPage.tsx logic exactly
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();

      const formData = new FormData(form);
      const email = formData.get('email');
      const password = formData.get('password');

      try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        if (!response.ok) {
          const errorText = await response.text();
          const errorMessage = JSON.parse(errorText).msg;
          showError(errorMessage);
          if (errorMessage === 'Email not confirmed') {
            window.location.href = '/email-confirmation';
          }
          return;
        }

        const data = await response.json();
        if (data.access_token) {
          localStorage.setItem('access_token', data.access_token);
          localStorage.setItem('userId', data.user.id);
        }
        localStorage.setItem('isLoggedIn', 'true');

        // Check if user profile exists
        const profileRes = await fetch(
          `${API_BASE_URL}/user_profiles/${encodeURIComponent(localStorage.getItem('userId') || '')}`
        );
        if (profileRes.ok) {
          window.location.href = '/';
        } else {
          window.location.href = '/complete-profile';
        }
      } catch (err) {
        showError(err.message || 'Login failed');
      }
    });

    // Google Sign-In - matches LoginPage.tsx logic
    document.getElementById('google-signin').addEventListener('click', async () => {
      try {
        // This would integrate with Supabase client in a real implementation
        // For now, simulate the OAuth redirect
        window.location.href = `${API_BASE_URL}/auth/google`;
      } catch (error) {
        showError('Failed to sign in with Google.');
      }
    });

    // Clear error on input
    const inputs = form.querySelectorAll('input');
    inputs.forEach(input => {
      input.addEventListener('input', hideError);
    });
  }

  // Initialize on DOM content loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeLogin);
  } else {
    initializeLogin();
  }
</script>
