---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
---

<Layout 
  title="Edit Profile | GemVoyage"
  description="Update your GemVoyage profile to personalize your travel discovery experience and connect better with fellow explorers."
  noIndex={true}
>
  <Navbar />
  <div class="max-w-2xl min-h-[60vh] mx-auto p-8 flex flex-col justify-center items-center">
    <h2 class="text-3xl font-bold mb-8">Edit Your Profile</h2>
    
    <div id="loading" class="text-lg hidden">Loading...</div>
    
    <form id="profile-form" class="w-full flex flex-col items-center hidden" style="max-width: 500px;">
      <label class="block mb-2 text-lg font-semibold w-full">First Name</label>
      <input
        type="text"
        id="firstName"
        name="firstName"
        class="w-full text-lg border-2 border-blue-600 rounded-xl p-4 mb-4 shadow focus:ring-2 focus:ring-blue-600 focus:outline-none"
        required
      />
      
      <label class="block mb-2 text-lg font-semibold w-full">Last Name</label>
      <input
        type="text"
        id="lastName"
        name="lastName"
        class="w-full text-lg border-2 border-blue-600 rounded-xl p-4 mb-4 shadow focus:ring-2 focus:ring-blue-600 focus:outline-none"
        required
      />
      
      <label class="block mb-2 text-lg font-semibold w-full">City</label>
      <input
        type="text"
        id="city"
        name="city"
        class="w-full text-lg border-2 border-blue-600 rounded-xl p-4 mb-4 shadow focus:ring-2 focus:ring-blue-600 focus:outline-none"
        required
      />
      
      <label class="block mb-2 text-lg font-semibold w-full">Bio</label>
      <textarea
        id="bio"
        name="bio"
        class="w-full min-h-[100px] text-lg border-2 border-blue-600 rounded-xl p-4 mb-4 shadow focus:ring-2 focus:ring-blue-600 focus:outline-none"
        rows="4"
        required
      ></textarea>
      
      <div id="error-message" class="text-red-600 mb-4 text-lg font-medium w-full text-center hidden"></div>
      <div id="success-message" class="text-green-600 mb-4 text-lg font-medium w-full text-center hidden"></div>
      
      <button
        type="submit"
        id="submit-button"
        class="px-6 py-3 bg-blue-600 text-white text-lg rounded-xl hover:bg-blue-700 transition w-full"
      >
        Save
      </button>
    </form>
  </div>
  <Footer />

  <script is:inline>
    const API_BASE_URL = import.meta.env.PUBLIC_API_BASE_URL;
    
    // Check authentication
    const isLoggedIn = (localStorage.getItem('isLoggedIn') === 'true' && localStorage.getItem('access_token') !== null && localStorage.getItem('userId') !== null);
    
    if (!isLoggedIn) {
      window.location.href = '/login';
    }

    const loadingDiv = document.getElementById('loading');
    const profileForm = document.getElementById('profile-form');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const submitButton = document.getElementById('submit-button');

    // Show loading
    if (loadingDiv) loadingDiv.classList.remove('hidden');

    // Fetch user profile
    const userId = localStorage.getItem('userId');
    
    if (!userId) {
      showError('User ID not found.');
      if (loadingDiv) loadingDiv.classList.add('hidden');
    } else {
      fetch(`${API_BASE_URL}/user_profiles/${userId}`)
        .then(async (res) => {
          if (!res.ok) throw new Error('Failed to fetch user profile');
          return res.json();
        })
        .then((data) => {
          const firstNameEl = document.getElementById('firstName');
          const lastNameEl = document.getElementById('lastName');
          const cityEl = document.getElementById('city');
          const bioEl = document.getElementById('bio');
          
          if (firstNameEl) firstNameEl.value = data.firstName || '';
          if (lastNameEl) lastNameEl.value = data.lastName || '';
          if (cityEl) cityEl.value = data.city || '';
          if (bioEl) bioEl.value = data.bio || '';
          
          if (loadingDiv) loadingDiv.classList.add('hidden');
          if (profileForm) profileForm.classList.remove('hidden');
        })
        .catch(() => {
          showError('Failed to fetch user profile.');
          if (loadingDiv) loadingDiv.classList.add('hidden');
        });
    }

    // Handle form submission
    if (profileForm) {
      profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        hideMessages();
        setLoading(true);
        
        const formData = new FormData(profileForm);
        const profile = {
          firstName: formData.get('firstName'),
          lastName: formData.get('lastName'),
          city: formData.get('city'),
          bio: formData.get('bio'),
        };

        try {
          const res = await fetch(`${API_BASE_URL}/user_profiles`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(profile),
          });
          
          if (!res.ok) {
            const text = await res.text();
            showError('Failed to update profile: ' + text);
          } else {
            showSuccess('Profile updated successfully!');
            setTimeout(() => {
              window.location.href = '/';
            }, 1200);
          }
        } catch (err) {
          showError('Failed to update profile.');
        } finally {
          setLoading(false);
        }
      });
    }

    function showError(message) {
      if (errorMessage) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
      }
      if (successMessage) successMessage.classList.add('hidden');
    }

    function showSuccess(message) {
      if (successMessage) {
        successMessage.textContent = message;
        successMessage.classList.remove('hidden');
      }
      if (errorMessage) errorMessage.classList.add('hidden');
    }

    function hideMessages() {
      if (errorMessage) errorMessage.classList.add('hidden');
      if (successMessage) successMessage.classList.add('hidden');
    }

    function setLoading(loading) {
      if (submitButton) {
        submitButton.textContent = loading ? 'Saving...' : 'Save';
        submitButton.disabled = loading;
      }
    }
  </script>
</Layout>
